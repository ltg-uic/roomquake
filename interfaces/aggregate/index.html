<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<!-- Your interface name here-->
	<title></title>
	<!-- The description of this interfaces here -->
	<meta name="description" content="">
	<!-- Your CSS here -->
  	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

  	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	<script src="nutella_lib.js" type="text/javascript"></script>
	<style>
		body {
	    	font-family: "Arial";
		}
	</style>

	<script type="text/javascript">

	// Parse the query parameters
	var query_parameters = NUTELLA.parseURLParameters();

	// Get an instance of nutella. 
	var nutella = NUTELLA.init(query_parameters.broker, query_parameters.app_id, query_parameters.run_id, NUTELLA.parseComponentId());

	nutella.net.subscribe("room_config_update", function(m){
		location.reload(true);
	});
	var S = 0; //currently selected seismograph range 0 (all) through 5
	var readings = [];
	var d_filters = [{min:0,max:100},{min:0,max:100},{min:0,max:100},{min:0,max:100},{min:0,max:100},{min:0,max:100}];
	var instantX = -1;
	var instantY = -1;
    $(function() {
		var canvas = document.getElementById("myCanvas");
		var ctx = canvas.getContext("2d");
		// redrawRoom();
		// ctx.fillStyle = "white";
  //   	ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);

  		nutella.net.publish( 'mode_update', {rq_mode : "demo"} );

		nutella.net.request("room_configuration", undefined, function(response) {
			nutella.net.request("get_readings",{},function(message){
				readings = message;
				// Update model
				document.getElementById('maxRoomX').value = response.room_width_meters;
				document.getElementById('maxRoomY').value = response.room_height_meters;
				for (var i=0; i<response.seismographs.length; i++){ 
					document.getElementById('x' + response.seismographs[i].id).value = response.seismographs[i].x;
					document.getElementById('y' + response.seismographs[i].id).value = response.seismographs[i].y;
				}
				// seismographs = response.seismographs;
				// mode = response.rq_mode;


		        var Xarrow = new Image();
		        Xarrow.src = 'Xarrow.png';

		        // WAIT TILL IMAGE IS LOADED.
		        Xarrow.onload = function () {
		            redrawRoom();
		        }

		        var Yarrow = new Image();
		        Yarrow.src = 'Yarrow.png';

		        // WAIT TILL IMAGE IS LOADED.
		        Yarrow.onload = function () {
		            redrawRoom();
		        }

		        $("input[name=s_sel]:eq(0)").click();
		        $('#filterDiv').hide();

		        nutella.net.subscribe("reading",function(arg){
		        	var record = response.seismographs.filter(function(item){
		        		return(item.id == arg.seismograph);
		        	})[0];
		        	var s = record.id;		        	
		        	var x = record.x; 
		        	var y = record.y;
		        	var d = Number(arg.distance);
		        	readings.push({s:s,x:x,y:y,d:d});
		        	nutella.net.publish('set_readings',readings);
		        	redrawRoom();


		        });

	            function drawCircle(x,y,r,color) {
	                ctx.fillStyle = "#FF0000";
	                ctx.beginPath();
	                ctx.arc(x, y, r, 0, 2 * Math.PI);
	                ctx.strokeStyle = color;
	                ctx.stroke();
	            }



		  //       $("#instant").click(function(){
		  //       	trigger();
		  //       });

		  //       $(".field").keyup(function(){ 
		  //       	redrawRoom();
		  //       });

		  //       $(".field").mouseout(function(){ 
		  //       	redrawRoom();
		  //       });

		  //       $("#save").click(function(){
		  //       	saveConfiguration();
		  //       });

		  //       $('#clear_demo_quakes').click(function() {
				// 	// Send message and reload
				// 	nutella.net.publish("demo_quakes_clean", {});
				// 	location.reload();
				// 	return false;
				// });

				canvas.addEventListener("mousedown",epicenter,false);

		        function epicenter(event){
		        	var rect = canvas.getBoundingClientRect(); 
		        	var pendingX = event.clientX-rect.left;
		        	var pendingY = event.clientY-rect.top;
		        	var cX = pendingX/ctx.canvas.width * document.getElementById("maxRoomX").value;
		        	if (cX > document.getElementById("maxRoomX").value)
		        		cX = document.getElementById("maxRoomX").value;
		        	if (cX < 0) cX = 0;
		        	var cY = document.getElementById("maxRoomY").value * (1 - pendingY/ctx.canvas.height);
		        	if (cY > document.getElementById("maxRoomY").value)
		        		cY = document.getElementById("maxRoomY").value;
		        	if (cY < 0) cY = 0;
		        	var newX = parseInt(cX*1000)/1000;
		        	var newY = parseInt(cY*1000)/1000;
		        	if (Math.abs(newX - instantX)< .2 && Math.abs(newY - instantY) < .2){
		        		instantX = -1;
		        		instantY = -1;
		        	} else {
		        		instantX = newX;
		        		instantY = newY;
		        	}
		        	// document.getElementById('instantX').value = 
		        	redrawRoom();
		        };



		        function saveConfiguration(){
					var m = {}
					m.room_width_meters = Number(document.getElementById("maxRoomX").value);
					m.room_height_meters = Number(document.getElementById("maxRoomY").value);
					m.seismographs = [];
					for (var i=0; i<5; i++) {
		    			var sX = Number(document.getElementById("x" + (i+1)).value);
		    			var sY = Number(document.getElementById("y" + (i+1)).value);
		    			if (sX <= 0 || sY <= 0) continue;
						m.seismographs.push( {id:i+1,x:sX,y:sY});
					}
					m.rq_mode = "demo";
					nutella.net.publish("room_config_update", m);
		        }



		        function redrawRoom(){ 
		        	var seismoSymbols = ["â‘ ","â‘¡","â‘¢","â‘£","â‘¤"];
		        	var maxX = Number(document.getElementById("maxRoomX").value);
		        	var maxY = Number(document.getElementById("maxRoomY").value);
		        	if (maxX <= 0 || maxY <= 0) return;
		        	if (maxX >= maxY) {
		        		ctx.canvas.width = 500;
		        		ctx.canvas.height = Math.floor(500 * (maxY / maxX));
		        	} else {
		        		ctx.canvas.height = 500;
		        		ctx.canvas.width = Math.floor(500 * (maxX / maxY));
		        	}
		        	ctx.fillStyle = "white";
		    		ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height);
		    		// var Xarrow=document.getElementById("Xarrow");
		    		ctx.drawImage(Xarrow,50,ctx.canvas.height-40);
		    		ctx.drawImage(Yarrow,10,ctx.canvas.height-160);
		    		ctx.fillStyle = "orange";
		    		ctx.font = "30px Arial";
		    		for (var i=0; i<5; i++){
		    			var sX = Number(document.getElementById("x" + (i+1)).value);
		    			var sY = Number(document.getElementById("y" + (i+1)).value);
		    			if (sX <= 0 || sY <= 0) continue;
		    			ctx.fillText(seismoSymbols[i],sX/maxX*ctx.canvas.width-15,ctx.canvas.height-(sY/maxY*ctx.canvas.height-11));
		    		};
					// if (document.getElementById("instantX").value > 0 && document.getElementById("instantY").value > 0) {
					// 	var x = document.getElementById("instantX").value/document.getElementById("maxRoomX").value * ctx.canvas.width;
					// 	var y = ctx.canvas.height - document.getElementById("instantY").value/document.getElementById("maxRoomY").value * ctx.canvas.height;
					// 	ctx.fillText("ðŸ’¥",x-15,y+12);
					// }

					var s = $('input[name=s_sel]:checked').val();
					var r = readings.filter(function(item){
						var keep = 	(s == 0 || s == item.s) &&
									(item.d >= d_filters[item.s].min) &&
									(item.d <= d_filters[item.s].max);
						return (keep);			
					});

					var mean_distance = [];
					var sum = [0,0,0,0,0,0];
					var count = [0,0,0,0,0,0];

					for (var i=0; i<r.length; i++){
						var x = m_to_screenX(r[i].x);
			        	var y = m_to_screenY(r[i].y);
			        	var d = r[i].d*unit(); 
			        	drawCircle(x,y,d,"silver");

			        	sum[r[i].s] += r[i].d;
			        	count[r[i].s]++;
		        	}

		        	$('#mean_distance').html("N/C");
					$('#mean_N').html("0")
		        	if (S > 0) {
			        	if (count[S] > 0) {
				        	var md = Math.round(sum[S]/count[S] * 1000)/1000;
				        	$('#mean_distance').html(md);
					        	$('#mean_N').html(count[S]);
				        	var thisS = response.seismographs.filter(function(item){
				        		return (item.id == S)
				        	})[0];
				        	drawCircle (m_to_screenX(thisS.x), m_to_screenY(thisS.y), md*unit(),"brown");
			        	}
			        } else {
				        	for (i=1; i<=5; i++) {
				        	if (count[i] > 0) {
					        	var md = Math.round(sum[i]/count[i] * 1000)/1000;
					        	$('#mean_distance').html(md);
					        	$('#mean_N').html(count[i]);
					        	var thisS = response.seismographs.filter(function(item){
					        		return (item.id == i)
					        	})[0];
					        	drawCircle (m_to_screenX(thisS.x), m_to_screenY(thisS.y), md*unit(),"brown");
				        	}			        		
			        	}

			        }

			        if (instantX >=0 && instantY>=0)
			        {
			        	var x = m_to_screenX(instantX);
						var y = m_to_screenY(instantY);
						ctx.fillText("ðŸ’¥",x-15,y+12);
						ctx.font="15px Arial";
						ctx.fillStyle = "brown";
						ctx.fillText('(' + instantX + ',' + instantY + ')',
							(x<370)?x+15:x-115,y+3);

			        }
		        }

		        function m_to_screenX (m) {
		        	return (m/document.getElementById("maxRoomX").value * ctx.canvas.width);
		        }

		        function m_to_screenY (m) {
		        	return (ctx.canvas.height * (1 - m/document.getElementById("maxRoomY").value));
		        }

		        function unit() {
		        	return (ctx.canvas.width/document.getElementById("maxRoomX").value);
		        }


		  //       function trigger() {
				// 	// Gather data
				// 	var mq = {};
				// 	mq.magnitude = document.getElementById("magnitude").selectedIndex+2;
				// 	mq.location = {};
				// 	mq.demo = true;
				// 	mq.location.x = Number(document.getElementById("instantX").value);
				// 	mq.location.y = Number(document.getElementById("instantY").value);
				// 	mq.time = new Date().toISOString();
				// 	mq.id = "d" + nextRQindex;
				// 	// Update model
				// 	// quakes.push(mq);
				// 	// // Update table view
				// 	// updateQuakesTableView('demo_quakes_table', true);
				// 	// Ship to backend
				// 	nutella.net.publish("new_demo_quake", mq);
				// 	document.getElementById("history").value = 
				// 		"RoomQuake " + nextRQindex++ + '\n' +
				// 		"Date: " + mq.time + '\n' +
				// 		"Epicenter X: " + mq.location.x + " Y: " + mq.location.y + 
				// 		"  Magnitude: " + mq.magnitude + '\n\n' +
				// 		document.getElementById("history").value;
				// 	// Hide mouse quake dot
				// 	// demo_p.manualQuakeX = -100;
				// 	// demo_p.manualQuakeY = -100;
				// };

				$("input[name=s_sel]").click(function(){
					S = this.value;
					if (S == 0) $('#filterDiv').hide(); else $('#filterDiv').show();
				    $('#d_min').val(d_filters[S].min);
				    $('#d_max').val(d_filters[S].max);
				    redrawRoom();
				});

				$("#d_min").keyup(function(){
					d_filters[S].min = this.value;
		        	redrawRoom();
		        });

				$("#d_max").keyup(function(){
					d_filters[S].max = this.value;
		        	redrawRoom();
		        });			

				$('#clearReadings').click(function(){
					readings = [];
					nutella.net.publish('set_readings',readings);
					redrawRoom();
				});
			
			});
		});

	});

    </script>

</head>
<body>

	<table >
		<tr>
			<td>
<!-- 			 	<input type="radio" name="system" value="English"> English<br>
  					<input type="radio" name="system" value="Metric"> Metric
 -->		</td>
			<td  align=center>
				<input readonly id="maxRoomX" class="field" type=text size=6 maxlength=6 value=10>
			</td>
			<td valign=top rowspan=3 style="padding: 20px;">
				<div align=center> 
					<b>Readings</b><br>
				 	All&nbsp<input type="radio" name="s_sel" value="0">&nbsp
				 	1&nbsp<input type="radio" name="s_sel" value="1"> &nbsp
				 	2&nbsp<input type="radio" name="s_sel" value="2"> &nbsp
				 	3&nbsp<input type="radio" name="s_sel" value="3"> &nbsp
				 	4&nbsp<input type="radio" name="s_sel" value="4"> &nbsp
				 	5&nbsp<input type="radio" name="s_sel" value="5"> &nbsp&nbsp&nbsp
				 <br><br>
				</div>
				<div align=center id="filterDiv">
					 <b>Filters</b><br>
					 Distance: Min <input type=text size=6 maxlength=6 id="d_min"> Max <input type=text size=6 maxlength=6 id="d_max">
					 <br><br>
					 <b>Means</b><br>N: <span id="mean_N"></span> &nbsp
					 Distance: <span id="mean_distance"></span>
				</div>
				<div align=center><br>
				<button id="clearReadings">Clear readings</button>
			</div>


<!-- 				<b>Instant quake</b><br><br>
				Epicenter:
				X: <input class="field" id="instantX" type=text size=6 maxlength=6>
				Y: <input class="field" id="instantY" type=text size=6 maxlength=6>
				
				Magnitude
				<select id="magnitude">
				  <option value="2">2</option>
				  <option value="3">3</option>
				  <option value="4">4</option>
				  <option value="5">5</option>
				</select><br><br>
				<button id="instant">Generate quake</button><br><br>
				Event History<br>
				<textarea id="history" rows=11 cols=40></textarea>
				<br><br><br>
				<button id="clear_demo_quakes">Clear demo quakes</button>
 -->

			</td>
		</tr>
		<tr>
			<td>
				<input readonly id="maxRoomY" class="field" type=text size=6 maxlength=6 value=10 style="transform:rotate(270deg);">
			</td>
			<td>
				<canvas id="myCanvas" width="500" height="500" style="border:1px solid black;">
					Your browser does not support the canvas element.
				</canvas>
			</td>
		</tr>
		<tr hidden>
			<td>
			</td>
			<td  align=center>
				Seismograph 1: X <input readonly class="field" id="x1" size=6 maxlength=6 type=text> Y <input readonly class="field" id="y1" size=6 maxlength=6 type=text><br>
				Seismograph 2: X <input readonly class="field" id="x2" size=6 maxlength=6 type=text> Y <input readonly class="field" id="y2" size=6 maxlength=6 type=text><br>
				Seismograph 3: X <input readonly class="field" id="x3" size=6 maxlength=6 type=text> Y <input readonly class="field" id="y3" size=6 maxlength=6 type=text><br>
				Seismograph 4: X <input readonly class="field" id="x4" size=6 maxlength=6 type=text> Y <input readonly class="field" id="y4" size=6 maxlength=6 type=text><br>
				Seismograph 5: X <input readonly class="field" id="x5" size=6 maxlength=6 type=text> Y <input readonly  class="field" id="y5" size=6 maxlength=6 type=text><br><br>
				<button hidden id="save">Save configuration</button>
			</td>
		</tr>
	</table>

</body>
</html>