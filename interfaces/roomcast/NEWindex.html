<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="roomCast">
  <title>roomCast</title>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="nutella_lib.js" type="text/javascript"></script>
  <style>

iframe { 
border: none; 
}

.blankpage {
  background: orange;
}
p {
    display: block;
    margin-top: 0;
    margin-bottom: 3px;
    margin-left: 0;
    margin-right: 0;
}

#tabs .ui-tabs-active {
  background: orange;
  border-style: none;
}

    .ui-tabs .ui-tabs-tab
    {
      background: lightyellow;       /* color of the little rim outide the tabs */
      cursor: pointer;

    }

    .ui-tabs
    {
      background: brown; /* color of the little rim outide the iframe */
      border: none;
    }

    .ui-tabs .ui-tabs-nav
    {
    background: brown; /* this is the background color of the tabs bar */
    border: none;
    }

    .ui-tabs .ui-tabs-panel 
    {
    background: orange; /* this is the background color of all the iframes */
    }
  </style>

<script type="text/javascript">
    
var portals,instances,activities,resources,design,activity,unitname;
var portal, instance;

$(function() {

  // set up the window

  var bottomOfHeader = 135; //hard-wired hack
  var bottomOfVisibleWindow = $(window).height(); 
  var h = bottomOfVisibleWindow - bottomOfHeader; 
  $( window ).resize(function() {
    bottomOfVisibleWindow = $(window).height(); 
    h = bottomOfVisibleWindow - bottomOfHeader;
    $("iframe").attr("height",h);
  });

  // initialize nutella 

  var query_parameters = NUTELLA.parseURLParameters();
  var nutella = NUTELLA.init(query_parameters.broker, query_parameters.app_id, query_parameters.run_id, NUTELLA.parseComponentId());

  //grab all the configuration data

  nutella.net.request('get_portals',{},function(message,from){
    portals = message;
    nutella.net.request('get_instances',{},function(message,from){
      instances = message;
      nutella.net.request('get_activities',{},function(message,from){
        activities = message;
        nutella.net.request('get_resources',{},function(message,from){
          resources = message;
          nutella.net.request('get_design',{},function(message,from){
            design = message;
            nutella.net.request('get_activity',{},function(message,from){
              activity = message;
              nutella.net.request('get_unitname',{},function(message,from){
                unitname = message;

                // default to 'designer' (portalID 1)

                var portalID = 1;
                var instanceID = 1;

                // substitute with query parameters if available

                if (query_parameters.hasOwnProperty('portal') &&
                    query_parameters.hasOwnProperty('instance')) { 
                      portalID = query_parameters.portal; 
                      instanceID = query_parameters.instance;
                };

                // find the portal object

                portal = portals.portalList.filter(function(item){
                  return (item.ID == portalID);
                })[0];

                // find the instance object within that portal

                instance = instances.data.filter(function(item){
                  return (item.portalID == portalID);
                })[0].instanceList.filter(function(item){
                  return (item.ID == instanceID);
                })[0];

                // build the page

                build_page();

              });
            });
          });
        });
      });
    });
  });
});

function build_page() {
  build_header_bar();
  build_tab_bar();
}

function build_header_bar() {
// this doesn't work. don't know why.  $('#unitName').innerHTML = unitname.name;
  document.getElementById('unitName').innerHTML = unitname.name.replace(/%20/g, " ");
  document.getElementById('portalName').innerHTML = portal.name.replace(/%20/g, " ");
  document.getElementById('instanceName').innerHTML = instance.name.replace(/%20/g, " ");
  document.getElementById('activityName').innerHTML = activity.name.replace(/%20/g, " ");
}

function build_tab_bar() {
  
  // find resources associated with this portal and activity
  // array r contains list of resultant resourceIDs

  // first get the list of resourceIDs associated with this portal and activity
  // specified in the design (array r)

  var r = design.data.filter(function (item) {
    return (item.activityID == activity.ID & item.portalID == portal.ID);
    }).map(function(item){return (item.resourceID)});
  
  
  var t;
  for (var i=0; i<r.length; i++) {
    alert(r[i]);
    t = resources.resourceList.filter(function(item){
      return (item.ID == r[i]);
    })[0];
    alert(t.URL);
//if (t.URL.substring(0,4) == "java") URL = ""; //legacy

//  construct a URL if the resource is a nutella interface module

    if ((t.URL != '') && (t.URL.substring(0,4) != "http")) { 
        var s = 'http://';
        s += window.location.host + '/';
        s += query_parameters.app_id + '/';
        s += query_parameters.run_id + '/';
        s += 'runs/';
        s += URL + '/';
        s += 'index.html' + '?';
        s += 'broker=' + query_parameters.broker + '&';
        s += 'app_id=' + query_parameters.app_id + '&';
        s += 'run_id=' + query_parameters.run_id ;
        t.URL = s; 
    }

//  build the tab for this resource

    $('#resources').append(
      $('<li><a href="#tabs-' + i + '">' + t.name + '</a></li>'));

//  build the iframe for this resource

    $('#tabs').append(
      $('<div id="tabs-' + i + '"><iframe src="' + URL + '" width=100% height=' + h + '></iframe></div>'));

  }; // end of for loop over resources

  // display the tabs and make them sortable

  $( "#tabs" ).tabs();
  $('.ui-tabs-nav').sortable();

}

  //   unitName = unitname;  
  //   document.getElementById('unitName').innerHTML = unitName.replace(/%20/g, " ");
  //   nutella.net.request('get_activity', {}, function(activity){  

  //     activityID = activity; 
  //     nutella.net.request('activity_name',activityID,function(arg){
  //       activityName = arg;
  //       document.getElementById('activityName').innerHTML = activityName.replace(/%20/g, " ");
  //       nutella.net.request('selected_resources',
  //         {portalID: portalID, activityID: activityID}, function(response,from){
  //       // response is an array. elements look like: {name: , URL: }
  //         console.log(response) ;
  //         if (portalID != -1) buildTabs(response);
  //         else buildTabs([{name:"portal",URL:"portal"}]);

  //   //        // nutella.net.subscribe('unitname_set',function(arg){alert('hey');document.getElementById('unitName').innerHTML=arg;});

  //       });  
  //     });
  //   });
  // });






  //     var query_parameters = NUTELLA.parseURLParameters();
  //     var nutella = NUTELLA.init(query_parameters.broker, query_parameters.app_id, query_parameters.run_id, NUTELLA.parseComponentId());
  //     var activityName = '';
  //     var activityID = -1;
  //     var portalID = -1;
  //     var instanceID = -1;
  //     // var instanceID = -1;
  //     var unitName = '';
  //     nutella.net.subscribe('distribution_set',function(message,from){ 
  //       if (message.portalID == portalID && (message.activityID == activityID || message.activityID == '*')) location.reload(true);});
      
  //     nutella.net.subscribe('activity_set',function(arg,from){ location.reload(true);});

  //     // nutella.net.subscribe('portals_set',function(message,from){location.reload(true);});
  //     // nutella.net.subscribe('activities_set',function(message,from){location.reload(true);});
  //     // nutella.net.subscribe('resources_set',function(message,from){location.reload(true);});


  //     if (query_parameters.hasOwnProperty('portalName')) {document.getElementById('portalName').innerHTML = query_parameters.portalName.replace(/%20/g, " ") + " • ";}
  //     if (query_parameters.hasOwnProperty('instanceName')) {document.getElementById('instanceName').innerHTML = query_parameters.instanceName.replace(/%20/g, " ") + " • ";}
  //     // if (query_parameters.hasOwnProperty('activityName')) {$('activityName').innerHTML = query_parameters.activityName.replace(/%20/g, " ");}


  //     if (query_parameters.hasOwnProperty('portalID') && query_parameters.hasOwnProperty('instanceID')) { 
  //       portalID = query_parameters.portalID; 
  //       instanceID = query_parameters.instanceID; 
  //     }; 

  //     document.getElementById('portalID').value = portalID; 
  //     document.getElementById('instanceID').value = instanceID; 
  //     document.getElementById('activityID').value = query_parameters.activityID; 


  //     function buildTabs(origResources){
  //       var resources=origResources;
  //       // this is a bit of a hack. portal is a privileged name, and it's not really protected.
  //       if (resources.length == 0) {
  //         resources.push({name:"portal",URL:"portal"});
  //         alert ('Sorry, there are no resources for that portal during this activity');
  //       }
  //       if (resources.length > 1) resources.unshift({name:'temp',URL:"javascript:alert('this should never happen');"});
  //       for (i=0; i<resources.length; i++) {
  //         var name = resources[i].name;
  //         var URL = resources[i].URL;
  //         if (URL.substring(0,4) == "java") URL = "";
  //         if ((URL != '') && (URL.substring(0,4) != "http")) { 
  //             var s = 'http://';
  //             s += window.location.host + '/';
  //             s += query_parameters.app_id + '/';
  //             s += query_parameters.run_id + '/';
  //             s += 'runs/';
  //             s += URL + '/';
  //             s += 'index.html' + '?';
  //             s += 'broker=' + query_parameters.broker + '&';
  //             s += 'app_id=' + query_parameters.app_id + '&';
  //             s += 'run_id=' + query_parameters.run_id ;
  //             URL = s; 
  //         }
  //         if (URL == '' && resources.length != 1) {
  //           $('#resources').append(
  //            $('<li><a hidden href="#tabs-' + i + '">' + name + '</a></li>'));
  //           $('#tabs').append(
  //             $('<div id="tabs-' + i + '"><iframe width=100% height=' + h + '></iframe></div>'));
  //         } else {
  //           $('#resources').append(
  //             $('<li><a href="#tabs-' + i + '">' + name + '</a></li>'));
  //           $('#tabs').append(
  //             $('<div id="tabs-' + i + '"><iframe src="' + URL + '" width=100% height=' + h + '></iframe></div>'));
  //         }
  //       };

  //       $( "#tabs" ).tabs();
  //       $('.ui-tabs-nav').sortable();

  //     };
  //   });

</script>
</head>
<body bgcolor=black >
  <div style="display:none;">
  portalID &nbsp <input type=text value="" id="portalID">&nbsp&nbsp&nbsp
  instanceID &nbsp <input type=text value=""  id="instanceID">&nbsp&nbsp&nbsp
  activityID &nbsp <input type=text value=""  id="activityID">&nbsp&nbsp&nbsp
  </div>

  <p id="titleSlot" style="color:white; text-align:center;font-size: 150%;font-family: sans-serif;">
      <span style="color:orange; float:left;" id="unitName"></span>
      <span id="portalName"></span>&nbsp•
      <span id="instanceName"></span>&nbsp•  
      <span id="activityName"></span>
      <span style="color:orange; float:right;">roomCast</span>
  </p>
<div id="tabs" >
  <ul id="resources">
  </ul>
</div>
<div id="blank">
<!--   <iframe src="http://localhost:57880/roomquake/default/runs/dummy/index.html"></iframe>
 -->  <!-- div for the blank frame -->
</div>
</body>
</html>