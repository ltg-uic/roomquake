<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RoomQuake Observations Entry</title>


	<!-- Make sure you have the foundation base, and icons (v3) CSS -->
	<link rel="stylesheet" type="text/css" href="_css/foundation.min.css" />
	<link rel="stylesheet" type="text/css" href="_foundation-icon-fonts-3/foundation-icons.css" />
	
	<!-- Add the foundation calendar CSS -->
	<link rel="stylesheet" type="text/css" href="_css/foundation_calendar.css" />
  	<link href='http://fonts.googleapis.com/css?family=Alegreya+Sans' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="_css/app.css" /> 
	
	
	<!-- Make sure you have jQuery, date.js loading properly -->
	<script type="text/javascript" src="_scripts/modernizr.js" charset="utf-8"></script>
	<script type="text/javascript" src="_scripts/jquery.js" ></script>

	<!-- Add the foundation calendar Javascript -->
	<script type="text/javascript" src="_scripts/foundation_calendar.js" ></script>
	<script type="text/javascript" src="_scripts/date.js" ></script>
	<script type="text/javascript" src="_helpers/date-helpers.js" ></script>
	<script type="text/javascript" src="_helpers/string-helpers.js" ></script>
	</head>

	<body>
	<script src="bower_components/bower-mqttws/mqttws31.js" type="text/javascript" charset="utf-8"></script>
	<script src="bower_components/simple-js-mqtt-client/simple-js-mqtt-client.js" type="text/javascript" charset="utf-8"></script>
	<script src="bower_components/nutella_lib/nutella_lib.js" type="text/javascript" charset="utf-8"></script>

	<div class="row">
		<div class="large-12 columns">
  		<img data-interchange="[_images/RoomQuakeHeader.png, (default)], [_images/RoomQuakeHeader_L.png, (large)], [_images/RoomQuakeHeader_M.png, (medium)], [_images/RoomQuakeHeader_S.png, (small)]">
		
		<noscript><img src="_images/RoomQuakeHeader.png"></noscript>
  	</div>
	<script>
		// Initialize nutella
		var query_params = nutella.init(location.search);

		//find out who this is
		var d = document.URL;
		var section = query_params.section;
		var stud_name = query_params.stud_name;
		document.write("<H1>Section: " + section + "   Student: " + stud_name + "</H1>");
		const NS = 4; //number of seismographs
	</script>
  </div>
  <form>
  <div class="row">
    <div class="large-6 medium-6 columns">
    <fieldset>
      <legend>Seismograph:</legend>
      	<select name="seismograph"required>
      		<option value="0" disabled /> </option>
			<script>
				for (var i=1; i <= NS; i++) {
					document.writeln('<option value="' + i + '">' + i + '</option>');
				}
			</script>
      	</select>
      	</label>
	</fieldset>
	<fieldset>
      <legend>Readings:</legend>
		P wave arrival time <input name="P_arrival" type="text" data-date-time data-date-format="%a, %d %b %Y" 
		data-time-format="%H:%M:%S:%L"/> </br>

		S wave arrival time <input name="S_arrival" type="text" data-date-time data-date-format="%a, %d %b %Y" 
		data-time-format="%H:%M:%S:%L"/></br>

		<!--<input type="text" name="S_arrival"  placeholder="should be date/time picker"> -->
		Maximum S amplitude <input type="text" name="amplitude" placeholder="mm"><br>
	</fieldset>    
  </div>

    <div class="large-6 medium-6 columns">
    <fieldset>
      <legend>Calculations:</legend>
		Difference in arrival times (S-P)<input type="text" required name="difference" placeholder="seconds">
		Distance <input type="text" name="distance"  placeholder="meters">
		Magnitude <input type="text" name="magnitude"><br>
		Time of event <input name="est_time" type="text" data-date-time data-date-format="%a, %d %b %Y" data-time-format="%k:%M:%S:%L"/>
	</fieldset>
	</div>
</div>

<div class="row">
 <div class="large-6  medium-6 columns">
    <button id="quake_observation" type="submit" class="button postfix">Submit</button>
  </div>
 <div class="large-6  medium-6 columns">
    <button class="button postfix" onClick='document.forms[0].reset();'>Reset</button>
  </div>
</div>

</form>

<script>
// Utility function used below
function checkField(f) {
	return f==undefined || f.value == ""
}

function isNumeric(f) {
	return !isNaN(parseFloat(f.value)) && isFinite(f.value);
}

$( document ).ready(function() {

	$("#quake_observation").click(function() {
		//	all fields must be filled
		try {
			if (document.forms[0].seismograph.value == 0) alert ("You must designate the seismograph that this readings is associated with");
			else if (checkField(document.forms[0].P_arrival)) alert ("You must enter the arrival time for the P wave");
			else if (checkField(document.forms[0].S_arrival)) alert ("You must enter the arrival time for the S wave");
			else if (checkField(document.forms[0].amplitude)) alert ("You must enter the maximum amplitude of the S wave");
			else if (!isNumeric(document.forms[0].amplitude)) alert ("Maximum amplitude of the S wave must be a number");
			// second column
			else if (checkField(document.forms[0].difference)) alert ("You must enter the difference between the arrival times of the P and S waves");
			else if (!isNumeric(document.forms[0].difference)) alert ("The difference between the arrival times of the P and S waves must be a number");
			else if (checkField(document.forms[0].distance)) alert ("You must enter the estimated distance of the event from this seismograph");
			else if (!isNumeric(document.forms[0].distance)) alert ("The estimated distance of the event from this seismograph must be a number");
			else if (checkField(document.forms[0].magnitude)) alert ("You must enter the estimated magnitude of this event");
			else if (!isNumeric(document.forms[0].magnitude)) alert ("The estimated magnitude of this event must be a number");
			else if (checkField(document.forms[0].est_time)) alert ("You must enter the estimated time of this event");
			else {
				
				// Assemble message
				var message = {
					p_arrival_time: customDateWithMillisParseUTC(document.forms[0].P_arrival.value).getTime(),
					s_arrival_time: customDateWithMillisParseUTC(document.forms[0].S_arrival.value).getTime(),
					quake_time: customDateWithMillisParseUTC(document.forms[0].est_time.value).getTime(),
					section: section, 
					stud_name: stud_name, 
					max_amplitude: parseFloat(document.forms[0].amplitude.value),
					sp_gap: parseFloat(document.forms[0].difference.value),
					seismograph: parseInt(document.forms[0].seismograph.value),
					distance: parseFloat(document.forms[0].distance.value),
					magnitude: parseFloat(document.forms[0].magnitude.value)
				};
				// console.debug( message );
				if (confirm("You are about to enter your observation. Remember, you can't change it later. Still want to submit?") == true) {
					nutella.publish("new_observation",message);
					alert ("Observation submitted successfully!");
					// cleanup
					document.forms[0].seismograph.options[Number(document.forms[0].seismograph.value)].disabled=true;
					document.forms[0].reset();
				} 
			}	
		} catch(e) {
			// This will help us catch all input errors in debug and not show them to the user
			console.error (e.message);
			// prevents event from bubbling up and reloading	
			return false;
		}	
		// prevents event from bubbling up and reloading
		return false;
	});
});
</script>

	<!-- Foundation plugins included here -->
	<script src="_scripts/foundation/foundation.js"></script>
	<script src="_scripts/foundation/foundation.interchange.js"></script>
  
  	<script>
  		$(document).foundation();
  	</script>
</body>
</html>