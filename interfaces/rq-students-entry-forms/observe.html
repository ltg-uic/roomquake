<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RoomQuake Observations Entry</title>


	<!-- Make sure you have the foundation base, and icons (v3) CSS -->
	<link rel="stylesheet" type="text/css" href="_css/foundation.min.css" />
	<link rel="stylesheet" type="text/css" href="_foundation-icon-fonts-3/foundation-icons.css" />
	
	<!-- Add the foundation calendar CSS -->
	<link rel="stylesheet" type="text/css" href="_css/foundation_calendar.css" />
  	<link href='http://fonts.googleapis.com/css?family=Alegreya+Sans' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="_css/app.css" /> 
	
	
	<!-- Make sure you have jQuery, date.js loading properly -->
	<script type="text/javascript" src="_scripts/modernizr.js" charset="utf-8"></script>
	<script type="text/javascript" src="_scripts/jquery.js" ></script>

	<!-- Add the foundation calendar Javascript -->
	<script type="text/javascript" src="_scripts/foundation_calendar.js" ></script>
	<script type="text/javascript" src="_scripts/date.js" ></script>
	<script type="text/javascript" src="_helpers/date-helpers.js" ></script>
	<script type="text/javascript" src="_helpers/string-helpers.js" ></script>
	
	
	<style type="text/css">
	label {
		margin-top: 20px;
	}
	code {
		font-size: 14px;
	}
	
	.row {
		margin-bottom: 20px;
	}
	
	.header {
		border-bottom: 1px solid #333;
	}
	
	dl dt {
		display: inline-block;
		width: 18%;
		margin-right: 1%;
		vertical-align: top;
	}
	
	dl dd {
		display: inline-block;
		width: 79%;
		vertical-align: top;
	}
	</style>
  </head>
<body>
	<script src="bower_components/bower-mqttws/mqttws31.js" type="text/javascript" charset="utf-8"></script>
	<script src="bower_components/simple-js-mqtt-client/simple-js-mqtt-client.js" type="text/javascript" charset="utf-8"></script>
	<script src="bower_components/nutella_lib/nutella_lib.js" type="text/javascript" charset="utf-8"></script>
	<script>
		// Initialize nutella
		var query_params = nutella.init(location.search);


		//find out who this is

		var d = document.URL;
		var section = query_params.section;
		var stud_name = query_params.stud_name;
		document.write("<H1>Section: " + section + "   Student: " + stud_name + "</H1>");
		//document.write('<div class="row"><div class="large-6 columns"><H1>Section: " + section + "   Student: " + name + "</H1>"'>);

		const NS = 4; //number of seismographs
	</script>





  <div class="row">
  	<div class="large-12 columns">
  		<img data-interchange="[_images/RoomQuakeHeader.png, (default)], [_images/RoomQuakeHeader_L.png, (large)], [_images/RoomQuakeHeader_S.png, (small)]">
		<noscript><img src="_images/RoomQuakeHeader_S.png"></noscript>
  	</div>
  </div>
  <form>
  <div class="row">
    <div class="large-6 medium-6 columns">
    <fieldset>
      <legend>Seismograph:</legend>
      	<select name="seismograph"required>
      		<option value="0" disabled /> </option>
			<script>
				for (var i=1; i <= NS; i++) {
					document.writeln('<option value="' + i + '">' + i + '</option>');
				}
			</script>
      	</select>
      	</label>
	</fieldset>    
  </div>
  </div>

<div class="row">
    <div class="large-6 medium-6 columns" >
    <fieldset>
      <legend>Readings:</legend>
		P wave arrival time <input type="text" data-date-time data-date-format="%a, %d %b %Y" 
		data-time-format="%H:%M:%S"/></br>

		S wave arrival time <input type="text" data-date-time data-date-format="%a, %d %b %Y" 
		data-time-format="%H:%M:%S"/></br>

		<!--<input type="text" name="S_arrival"  placeholder="should be date/time picker"> -->
		Maximum S amplitude <input type="text" name="amplitude" placeholder="mm"><br>
	</fieldset>    
  </div>
  <div class="large-6 medium-6 columns">
    <fieldset>
      <legend>Calculations:</legend>
		Difference in arrival times (S-P)<input type="text" required name="difference" placeholder="seconds">
		Distance <input type="text" name="distance"  placeholder="meters">
		Magnitude <input type="text" name="magnitude"><br>
		Time of event <input type="text" data-date-time data-date-format="%a, %d %b %Y" data-time-format="%k:%M:%S"/>
	</fieldset>    
  </div>
</div>
<div class="row">
 <div class="large-6  medium-6 columns">
    <button id="quake_observation" type="submit" class="button postfix">Submit</button>
  </div>
 <div class="large-6  medium-6 columns">
    <button class="button postfix" onClick='document.forms[0].reset();'>Reset</button>
  </div>
</div>

</form>

<script>
// Utility function used below
function checkField(f) {
	return f==undefined || f.value == ""
}

$( document ).ready(function() {

	$("#quake_observation").click(function() {
		//	all fields must be filled
		try {
			if (document.forms[0].seismograph.value == 0) alert ("You must designate the seismograph that this readings is associated with");
			// TODO Uncomment once picker is finished
			// else if (checkField(document.forms[0].P_arrival)) alert ("You must enter the arrival time for the P wave");
			// else if (checkField(document.forms[0].S_arrival)) alert ("You must enter the arrival time for the S wave");
			else if (checkField(document.forms[0].amplitude)) alert ("You must enter the maximum amplitude of the S wave");
			// second column
			else if (checkField(document.forms[0].difference)) alert ("You must enter the difference between the arrival times of the P and S waves");
			else if (checkField(document.forms[0].distance)) alert ("You must enter the estimated distance of the event from this seismograph");
			else if (checkField(document.forms[0].magnitude)) alert ("You must enter the estimated magnitude of this event");
			// TODO Uncomment once picker is finished
			//else if (checkField(document.forms[0].time)) alert ("You must enter the estimated time of this event");
			else {

				// Create fake values for p_arrival, s_arrival, time and sp_gap
				// TODO store real values!!!!
				var quake_time = new Date().getTime()+10000;
				var p_arrival_time = quake_time+ Math.random()*5000;
				var s_arrival_time = p_arrival_time + Math.random()*10000; 
				var sp_gap = s_arrival_time - p_arrival_time;

				// publish info
				var message = {
					p_arrival_time: p_arrival_time,
					s_arrival_time: s_arrival_time,
					quake_time: quake_time,
					section: section, 
					stud_name: stud_name, 
					max_amplitude: document.forms[0].amplitude.value,
					sp_gap: sp_gap,
					seismograph: parseInt(document.forms[0].seismograph.value),
					distance: parseFloat(document.forms[0].distance.value),
					magnitude: parseInt(document.forms[0].magnitude.value)
				};
				console.debug( message );
				nutella.publish("new_observation",message);
				
				// cleanup
				document.forms[0].seismograph.options[Number(document.forms[0].seismograph.value)].disabled=true;
				document.forms[0].reset();
			}	
		} catch(e) {
			// This will help us catch all input errors in debug and not show them to the user
			console.error (e.message);
			// prevents event from bubbling up and reloading	
			return false;
		}	
		// prevents event from bubbling up and reloading
		return false;
	});
});
</script>

	<!-- Foundation plugins included here -->
	<script src="_scripts/foundation/foundation.js"></script>
	<script src="_scripts/foundation/foundation.interchange.js"></script>
  
  	<script>
  		$(document).foundation();
  	</script>
</body>
</html>