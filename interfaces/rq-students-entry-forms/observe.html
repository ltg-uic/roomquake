<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RoomQuake Observations Entry</title>


	<!-- Make sure you have the foundation base, and icons (v3) CSS -->
	<link rel="stylesheet" type="text/css" href="_css/foundation.min.css" />
	<link rel="stylesheet" type="text/css" href="_foundation-icon-fonts-3/foundation-icons.css" />
	
	<!-- Add the foundation calendar CSS -->
	<link rel="stylesheet" type="text/css" href="_css/foundation_calendar.css" />
  	<link href='http://fonts.googleapis.com/css?family=Alegreya+Sans' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="_css/app.css" /> 
	
	
	<!-- Make sure you have jQuery, date.js loading properly -->
	<script type="text/javascript" src="_scripts/modernizr.js" charset="utf-8"></script>
	<script type="text/javascript" src="_scripts/jquery.js" ></script>

	<!-- Add the foundation calendar Javascript -->
	<script type="text/javascript" src="_scripts/foundation_calendar.js" ></script>
	<script type="text/javascript" src="_scripts/date.js" ></script>
	<script type="text/javascript" src="_helpers/date-helpers.js" ></script>
	<script type="text/javascript" src="_helpers/string-helpers.js" ></script>
	</head>

	<body>
	<script src="bower_components/bower-mqttws/mqttws31.js" type="text/javascript" charset="utf-8"></script>
	<script src="bower_components/simple-js-mqtt-client/simple-js-mqtt-client.js" type="text/javascript" charset="utf-8"></script>
	<script src="bower_components/nutella_lib/nutella_lib.js" type="text/javascript" charset="utf-8"></script>

	<div class="row">
		<div class="large-12 columns">
  		<img data-interchange="[_images/RoomQuakeHeader.png, (default)], [_images/RoomQuakeHeader_L.png, (large)], [_images/RoomQuakeHeader_M.png, (medium)], [_images/RoomQuakeHeader_S.png, (small)]">
		
		<noscript><img src="_images/RoomQuakeHeader.png"></noscript>
  	</div>
	<script>
		// Initialize nutella
		var query_params = nutella.init(location.search);

		//find out who this is
		var d = document.URL;
		var section = query_params.section;
		var stud_name = query_params.stud_name;
		document.write("<H1>Section: " + section + "   Student: " + stud_name + "</H1>");
		const NS = 4; //number of seismographs
	</script>
  </div>
  <form>
  <div class="row">
    <div class="large-6 medium-6 columns">
    <fieldset>
      <legend>Seismograph:</legend>
      	<select name="seismograph"required>
      		<option value="0" disabled /> </option>
			<script>
				for (var i=1; i <= NS; i++) {
					document.writeln('<option value="' + i + '">' + i + '</option>');
				}
			</script>
      	</select>
      	</label>
	</fieldset>
	<fieldset>
      <legend>Readings:</legend>
		
		P wave arrival time 
		<div class="row">
			<div class="small-6 columns">
				<input name="P_arrival" type="text" data-date data-date-format="%a, %d %b %Y"/>
			</div>
			<div class="small-6 columns">
				<input type="text" class="ltg-time-input" name="p_time" placeholder="HH:mm:ss.d">
			</div>
		</div>
		

		S wave arrival time 
		<div class="row">
			<div class="small-6 columns">
				<input name="S_arrival" type="text" data-date data-date-format="%a, %d %b %Y"/>
			</div>
			<div class="small-6 columns">
				<input type="text" class="ltg-time-input" name="s_time" placeholder="HH:mm:ss.d">
			</div>
		</div>
		
		Maximum S amplitude <input type="text" name="amplitude" placeholder="mm"><br>
	</fieldset>    
  </div>

    <div class="large-6 medium-6 columns">
    <fieldset>
      <legend>Calculations:</legend>
		Difference in arrival times (S-P)<input type="text" required name="difference" placeholder="seconds">
		Distance <input type="text" name="distance"  placeholder="meters">
		Magnitude <input type="text" name="magnitude"><br>
		Time of event 
		<div class="row">
			<div class="small-6 columns">
				<input name="est_date" type="text" data-date data-date-format="%a, %d %b %Y"/>
			</div>
			<div class="small-6 columns">
				<input type="text" class="ltg-time-input" name="est_time" placeholder="HH:mm:ss.d">
			</div>
		</div>
	</fieldset>
	</div>
</div>

<div class="row">
 <div class="large-6  medium-6 columns">
    <button id="quake_observation" type="submit" class="button postfix">Submit</button>
  </div>
 <div class="large-6  medium-6 columns">
    <button class="button postfix" onClick='document.forms[0].reset();'>Reset</button>
  </div>
</div>

</form>

<script>
// Utility function used below
function checkField(f) {
	if (section=="6LM") return false;			// HACK TO REMOVE VALIDATION
	return f==undefined || f.value == ""
}

function isNumeric(f) {
	if (section=="6LM" && f.value == "") return true;			// HACK TO REMOVE VALIDATION
	return !isNaN(parseFloat(f.value)) && isFinite(f.value);
}

function checkTimeFormat(e) {
	if (section=="6LM" && e.value == "") return false;			// HACK TO REMOVE VALIDATION
	// Check that the date is in HH:mm:ss.d format
	f = e.value.split(':');  // HH=f[0], mm=f[1]
	if (f.length!=3) return true;
	ff = f[2].split('.');	// ss = ff[0], d=ff[1]
	if (ff.length!=2) return true;
	var  HH=f[0], mm=f[1], ss = ff[0], d=ff[1];
	if (HH.length>2) return true;
	if (mm.length>2) return true;
	if (ss.length>2) return true;
	if (d.length!=1) return true;
	// Time has right time format
	return false; 
}

function checkTimeValue(e) {
	if (section=="6LM" && e.value == "") return false;			// HACK TO REMOVE VALIDATION
	f = e.value.split(':');	// HH=f[0], mm=f[1]
	ff = f[2].split('.');	// ss = ff[0], d=ff[1]
	var  HH=f[0], mm=f[1], ss = ff[0], d=ff[1];
	try {
		if (isNaN(parseInt(HH))) return true; 
		if (isNaN(parseInt(mm))) return true; 
		if (isNaN(parseInt(ss))) return true; 
		if (isNaN(parseInt(d))) return true; 
	} catch(e) {
		// If values are not number, date value is wrong
		return true;
	}
	if (HH<0 || HH>23 ) return true;
	if (mm<0 || mm>59 ) return true;
	if (ss<0 || ss>59 ) return true;
	if ( d<0 ||  d>9  ) return true;

	// Time has right time format
	return false; 
}

$( document ).ready(function() {

	$("#quake_observation").click(function() {
		//	all fields must be filled
		try {
			if (document.forms[0].seismograph.value == 0) alert ("You must designate the seismograph that this readings is associated with");
			// P waves arrival time
			else if (checkField(document.forms[0].P_arrival)) alert ("You must enter the arrival date for the P wave");
			else if (checkField(document.forms[0].p_time)) alert ("You must enter the arrival time for the P wave");
			else if (checkTimeFormat(document.forms[0].p_time)) alert ("You must enter the arrival time for the P wave as HH:mm:ss.d");
			else if (checkTimeValue(document.forms[0].p_time)) alert ("The P wave arrival time you entered doesn't seem to be valid.");
			// S waves arrival time
			else if (checkField(document.forms[0].S_arrival)) alert ("You must enter the arrival date for the S wave");
			else if (checkField(document.forms[0].s_time)) alert ("You must enter the arrival time for the S wave");
			else if (checkTimeFormat(document.forms[0].s_time)) alert ("You must enter the arrival time for the S wave as HH:mm:ss.d");
			else if (checkTimeValue(document.forms[0].s_time)) alert ("The S wave arrival time you entered doesn't seem to be valid.");
			// Max amplitude
			else if (checkField(document.forms[0].amplitude)) alert ("You must enter the maximum amplitude of the S wave");
			else if (!isNumeric(document.forms[0].amplitude)) alert ("Maximum amplitude of the S wave must be a number");
			// S-P gap
			else if (checkField(document.forms[0].difference)) alert ("You must enter the difference between the arrival times of the P and S waves");
			else if (!isNumeric(document.forms[0].difference)) alert ("The difference between the arrival times of the P and S waves must be a number");
			// Distance
			else if (checkField(document.forms[0].distance)) alert ("You must enter the estimated distance of the event from this seismograph");
			else if (!isNumeric(document.forms[0].distance)) alert ("The estimated distance of the event from this seismograph must be a number");
			// Magnitude
			else if (checkField(document.forms[0].magnitude)) alert ("You must enter the estimated magnitude of this event");
			else if (!isNumeric(document.forms[0].magnitude)) alert ("The estimated magnitude of this event must be a number");
			// Event time
			else if (checkField(document.forms[0].est_date)) alert ("You must enter the estimated date of this event");
			else if (checkField(document.forms[0].est_time)) alert ("You must enter the estimated time of this event");
			else if (checkTimeFormat(document.forms[0].est_time)) alert ("You must enter the estimated time of this event as HH:mm:ss.d");
			else if (checkTimeValue(document.forms[0].est_time)) alert ("The estimated time of this event you entered doesn't seem to be valid.");
			// Compose results
			else {
				
				// Assemble message
				var p_a_t = document.forms[0].p_time.value;
				var s_a_t = document.forms[0].s_time.value;
				var e_a_t = document.forms[0].est_time.value;
				var m_a = parseFloat(document.forms[0].amplitude.value);
				var sp = parseFloat(document.forms[0].difference.value);
				var d = parseFloat(document.forms[0].distance.value);
				var mag = parseFloat(document.forms[0].magnitude.value);
				var message = {
					p_arrival_time: p_a_t=="" ? "" : customDateParseUTC(document.forms[0].P_arrival.value, document.forms[0].p_time.value),
					s_arrival_time: s_a_t=="" ? "" : customDateParseUTC(document.forms[0].S_arrival.value, document.forms[0].s_time.value),
					quake_time: 	e_a_t=="" ? "" : customDateParseUTC(document.forms[0].est_date.value,  document.forms[0].est_time.value),
					section: section, 
					stud_name: stud_name, 
					max_amplitude: isNaN(m_a) ? "" : m_a,
					sp_gap: isNaN(sp) ? "" : sp,
					seismograph: parseInt(document.forms[0].seismograph.value),
					distance: isNaN(d) ? "" : d,
					magnitude: isNaN(mag) ? "" : mag
				};
				
				if (confirm("You are about to enter your observation. Remember, you can't change it later. Still want to submit?") == true) {
					//console.debug( message );
					nutella.publish("new_observation",message);
					alert ("Observation submitted successfully!");
					// cleanup
					document.forms[0].seismograph.options[Number(document.forms[0].seismograph.value)].disabled=true;
					document.forms[0].reset();
				} 
			}	
		} catch(e) {
			// This will help us catch all input errors in debug and not show them to the user
			console.error (e.message);
			// prevents event from bubbling up and reloading	
			return false;
		}	
		// prevents event from bubbling up and reloading
		return false;
	});
});
</script>

	<!-- Foundation plugins included here -->
	<script src="_scripts/foundation/foundation.js"></script>
	<script src="_scripts/foundation/foundation.interchange.js"></script>
  
  	<script>
  		$(document).foundation();
  	</script>
</body>
</html>